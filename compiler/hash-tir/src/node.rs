use derive_more::Deref;
use hash_ast::ast::AstNodeId;
use hash_source::{location::Span, SourceId};

/// Represents a node in the TIR.
///
/// Each node has an origin, and data associated with it.
#[derive(Debug, Deref, Copy, Clone, PartialEq, Eq)]
pub struct Node<Data> {
    pub origin: NodeOrigin,
    #[deref]
    pub data: Data,
}

impl<Data> Node<Data> {
    pub fn new(data: Data, origin: NodeOrigin) -> Self {
        Self { data, origin }
    }

    pub fn node(&self) -> Option<AstNodeId> {
        self.origin.node()
    }

    pub fn span(&self) -> Option<Span> {
        self.node().map(|n| n.span())
    }

    pub fn source(&self) -> Option<SourceId> {
        self.node().map(|n| n.source())
    }
}

impl<D, Data: From<D>> From<(D, NodeOrigin)> for Node<Data> {
    fn from((d, o): (D, NodeOrigin)) -> Self {
        Node::new(d.into(), o)
    }
}

#[derive(Copy, Clone, Debug, PartialEq, Eq)]
pub enum NodeOrigin {
    /// The node was given by the user.
    Given(AstNodeId),
    /// The node was created through type inference of the given origin.
    InferredFrom(AstNodeId),
    /// The node was generated by the compiler, and has no origin.
    Generated,
}

impl NodeOrigin {
    pub fn node(&self) -> Option<AstNodeId> {
        match self {
            NodeOrigin::Given(node) | NodeOrigin::InferredFrom(node) => Some(*node),
            NodeOrigin::Generated => None,
        }
    }
}

/// Helper to create a node which is the value of a static store.
#[macro_export]
macro_rules! node {
    ($data:expr) => {{
        use hash_storage::store::statics::SingleStoreValue;
        $crate::node::Node::create($crate::node::Node::new(
            $data,
            $crate::node::NodeOrigin::Generated,
        ))
    }};
    ($data:expr, $origin:expr) => {
        $crate::node::Node::create($crate::node::Node::new($data, $origin))
    };
}

/// Helper to create a node which is the value of a static store.
#[macro_export]
macro_rules! node_value {
    ($data:expr) => {
        $crate::node::Node::new($data, $crate::node::NodeOrigin::Generated)
    };
    ($data:expr, $origin:expr) => {
        $crate::node::Node::new($data, $origin)
    };
}
